{% extends 'base/AdminLTE_base.html' %}
{% block title %}添加合同{% endblock %}

{% block style %}
    <style>
        p {
            width: 100%;
            overflow: hidden;
        }
        input,select{
            border:0;
	        width: 100%;
        }
        /* datepicker */
	    .datepicker-days td, .datepicker-days th {
            width:35px;
        }
        /* 表格超出隐藏 */
	    tr th,
    	tr td{
        	text-align: center;
        	overflow: hidden;
        	white-space: nowrap;
        	text-overflow: ellipsis;
    	}
        /* 搜索框位置 */
        .padmar{
            margin:10px;
        }
        /* 表格cancel按钮居中 */
        .layui-table-tips-c:before {
            right: 1px;
            top: -3px;
        }
    </style>
{% endblock %}

{% block path %}
    <ol class="breadcrumb">
        <li><a href="{% url 'home' %}"><i class="fa fa-dashboard"></i> 主页</a></li>
        <li class="active">采购管理</li>
        <li class="active">采购合同</li>
    </ol>
{% endblock %}
{% block main_title %}
    销售合同添加
{% endblock %}


{% block main_content %}
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info box-solid">
                <div class="box-header with-border">
                    <h6 class="box-title">
                        <button class="layui-btn layui-btn-normal" data-method="submit">
                            <i class="fa fa-save"></i> Save</button>
                        <a class="btn">
                            <i class="fa fa-repeat"></i> Repeat
                        </a>
                    </h6>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                        <button type="button" class="btn btn-box-tool" id="deleteproduct"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <table class="table" id="sales_order_add">
                        <tr>
                            <td>
                            <input type="text" name="csrfmiddlewaretoken" value="{{ csrf_token }}" hidden="hidden">
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">合同编号</span>
                                    {{ form.sales_num }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">业务员</span>
                                    {{ form.salesman }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">采购员</span>
                                    {{ form.buyer }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">客户</span>
                                    {{ form.client }}
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-info btn-flat">选择</button>
                                    </span>

                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">签约日期</span>
                                    {{ form.date }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">装运口岸</span>
                                    {{ form.shipment_port }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">目的口岸</span>
                                    {{ form.destination_port }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">币种</span>
                                    {{ form.currency }}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">价格条款</span>
                                    {{ form.price_clause }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">出口公司</span>
                                    {{ form.export_company }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">运输方式</span>
                                    {{ form.mode_of_transport }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">汇率</span>
                                    {{ form.exrate }}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">运费</span>
                                    {{ form.shipping_fee }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">保险费</span>
                                    {{ form.insurance }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">其他费用</span>
                                    {{ form.other_fee }}
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm form-inline {% if form.sales_num.errors %}has-error{% endif %}">
                                    <span class="input-group-addon">总金额</span>
                                    {{ form.total_amount }}
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                <!-- /.box-body -->
                <div class="box-footer"></div>
                <!-- box-footer -->
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="box box-primary box-solid">
                        <div class="box-header with-border">
                            <div class="pull-left">
                                <h3 class="box-title">产品列表</h3>
                            </div>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" id="delete_product"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <table class="layui-hide" id="layuiDemo" lay-filter="test"></table>
                        </div>
                        <div class="box-footer">

                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
            <div class="col-md-12">
                <div class="box box-default box-solid">
                    <div class="box-header with-border">
                        <div class="pull-left">
                            <h6 class="box-title">收款计划</h6>
                        </div>
                        <div class="box-tools pull-right">
                            <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                            <button type="button" class="btn btn-box-tool" id="delete_product"><i class="fa fa-times"></i></button>
                        </div>
                    </div>
                    <div class="box-body">
                        <div class="layui-table-tool">
                            <div class="layui-btn-container">
                                <button type="button" class="layui-btn layui-btn-sm" id="collection_add"><span>添加</span></button>
                                <button type="button" id="Remove_collection" class="layui-btn layui-btn-sm"><span>删除</span></button>
                            </div>
                        </div>
                        
                        <table class="table table-bordered table-hover table-condensed" style="table-layout:fixed;word-break:break-all;">
                            <thead>
                                <tr>
                                    <th style="width:5%"><input type="checkbox" id="select_all2" style="width: 18px;height: 18px;"></th>
                                    <th>收款类型</th>
                                    <th>预计收款日期</th>
                                    <th>金额</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody id="collection"></tbody>
                        </table>
                    </div>
                    <div class="box-footer"></div>
                </div>
            </div>
        </div>
        <div class="pull-right">
            <button class="layui-btn layui-btn-normal" data-method="submit"><i class="fa fa-save"></i> Save</button>
        </div>
                
    </div>
</div>
<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <a type="button" data-method="setTop" href="javascript:void(0)" class="layui-btn layui-btn-sm" lay-event="add">添加</a>
        <a type="button" data-method="delete" href="javascript:void(0)" class="layui-btn layui-btn-sm" lay-event="delete">删除</a>
    </div>
</script>
<div style="display:none" id="infoDemo">
    <div class="infoDemo padmar">
        搜索：
        <div class="layui-inline">
            <input class="layui-input" name="id" id="demoReload" autocomplete="off">
        </div>
        <button class="layui-btn" data-method="reloadchild">搜索</button>
    </div>
    <table class="layui-hide"  id="firstBlood" lay-filter="demo"></table>
</div>
<script type="text/html" id="titleTpl">
    <a class="layui-btn layui-btn-danger layui-btn-xs" data-id="{{d.product_id}}"  data-method="reload" lay-event="add">添加</a>
</script>
{% endblock %}

{% block script %}
<script>
    var obj = {
    init: function (data) {
        var data = data;
        this.bind(data);
    },
    subdact:function(){ //     判断是否有减数
        var amount = $("#id_total_amount").val();
        var subtraction = $('#id_bill_amount').val();
        var remain = parseInt(amount - subtraction);
        if(subtraction===undefined){

        }else if(remain >= 0){
            $("#id_not_bill_amount").val(remain);
        }else{
            alert("请注意！");
            $('#id_bill_amount').val(0);
            $("#id_not_bill_amount").val(amount);
        }
    },
    callback: function (data) {
        var list = {};
        var map = new Map();
        $.each(data, function (index, item) {
            var key = $(item).prop("name");
            var value = $(item).val();
            list[key] = value;
        });
        return list;
    },
    get_exrate:function(){
            var currency = $("#id_currency").val();
            $.getJSON("/finance/get_exchange_rate/", {'currency': currency}, function (index, status) {
                $('#id_exrate').val(index);
            })
    },
    bind: function (data) {
        var self = this;
        var formdata;
        layui.use(['table', 'layer'], function () {
            var table = layui.table;
            var $ = layui.$;
            var layer = layui.layer;
            table.render({              //父页面的table
                elem: '#layuiDemo'
                , data: data
                , toolbar: '#toolbarDemo'
                , page: true
                ,defaultToolbar:[]
                , id: 'testReload'
                , cols: [[
                    {type: 'checkbox', align: "center"}
                    , {field: "product__product_id", title: "产品代码", align: "center"}
                    , {field: "name", title: "名字", align: "center"}
                    , {field: "spec", title: "规格", align: "center"}
                    , {field: "remark", title: "备注", align: "center", edit: 'text'}
                    , {field: "mesu_unit", title: "单位", align: "center"}
                    , {field: "volume", title: "体积", align: "center"}
                    , {field: "unit_price", title: "单价", align: "center", edit: 'text'}
                    , {field: "count", title: "数量", align: "center", edit: 'text'}
                    , {field: "amount", title: "金额", align: "center"}
                ]]
            });
            table.render({             //子页面的table
                elem: '#firstBlood'
                , url: '/product/product_select'
                , page: true
                , id: 'testchange'
                , cols: [[
		    {field: "product_id", title: "产品id", align: "center", width: 100}
                    , {field: "name", title: "产品名称", align: "center", width: 100}
                    , {field: "spec", title: "产品规格", align: "center", width: 200}
                    , {field: "mesu", title: "计量单位", align: "center", width: 200}
                    , {field: "volume", title: "体积", align: "center", width: 100}
                    , {title: "操作", toolbar: '#titleTpl', align: "center", width: 100}
                ]]
                , parseData: function (res) { //res 即为原始返回的数据
                    return {
                        "code": res.status, //解析接口状态
                        "msg": res.message, //解析提示文本
                        "count": res.total, //解析数据长度
                        "data": res.data //解析数据列表
                    };
                },
            });
            table.on('edit(test)', function (obj) {        //  监听开启编辑，计算金额和总金额
                var data = obj.data;
                active.calculat(data);
            });
            table.on('tool(demo)', function (obj) {            //  监听子页面的tool操作
                var data = obj.data;
                var arr = [];
                var self = this;
                layEvent = obj.event; //获得 lay-event 对应的值
                var getdata = table.cache.testReload;

                $.each(getdata, function (index, item) {
                    arr.push(item.product_id);
                });
                var number = arr.findIndex(function (value) {
                    return value == data.product_id
                });
                console.log(number);
                if (number === -1) {
                    var othis = $(this), method = othis.data('method');
                    active[method] ? active[method].call(this, getdata) : '';

                    if (layEvent === 'add') {
                        $.ajax({
                            type: 'get',
                            data: {'product_id': data.product_id},
                            url: '/product/get_product',
                            success: function (res) {
                                console.log(res);
                                getdata.push({
                                    'product__product_id': res.data[0].product_id,
                                    'name': res.data[0].name,
                                    'spec': res.data[0].spec,
                                    'mesu': res.data[0].mesu_unit,
                                    'volume': res.data[0].volume
                                });
                                table.reload('testReload', {
                                    page: {
                                        curr: 1 //重新从第 1 页开始
                                    }
                                    , data: getdata
                                });
                            }
                        })
                    }
                }
            });

            table.on('toolbar(test)', function (obj) {         //table头部事件监听
                var checkStatus = table.checkStatus(obj.config.id);
                switch (obj.event) {
                    case 'add':
                        var othis = $(this), method = othis.data('method');
                        active[method] ? active[method].call(this, othis) : '';
                        break;
                    case 'delete':
                        var arr = [];
                        var id_arr = [];
                        var getdata = table.cache.testReload;

                        $.each(checkStatus.data, function (index, item) {
                            id_arr.push(item.product_id);
                        });
                        for (var value of getdata) {
                            if (id_arr.indexOf(value.product_id) === -1) {
                                arr.push(value);
                            }
                        }
                        ;
                        var count_num = 0;
                        $.each(arr, function (index, item) {
                            count_num += parseInt(item.amount);
                        });
                        //input框
                        var data1 = $("#sales_order_add input.changeable");
                        $.each(data1, function (index, item) {
                            count_num = count_num + parseInt($(item).val());
                        });
                        $("#id_total_amount").val(count_num);
                        self.subdact();

                        table.reload('testReload', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            }
                            , data: arr
                        });
                        break;
                }
                ;
            });
            var active = {
                setTop: function () {            //  监听按钮add 开启弹出层
                    var that = this;
                    layer.open({
                        type: 1
                        , content: $('#infoDemo')
                        , title: '添加产品'
                        , area: ['auto','auto']
                        , shadeClose: true
                        , shade: .3
                        , zIndex: layer.zIndex //重点1
                        , success: function (layero) {
                            layer.setTop(layero); //重点2
                        }
                        , btn: ['全部关闭'] //只是为了演示
                        , yes: function () {
                            layer.closeAll();
                        }
                    })
                },
                reload: function (data) {             //重载
                    //执行重载
                    table.reload('testReload', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        }
                        , data: data
                    });
                },
                reloadchild: function () {               //子页面搜索
                    var demoReload = $('#demoReload');
                    //执行重载
                    table.reload('testchange', {
                        // page: {
                        //     curr: 1 //重新从第 1 页开始
                        // }
                        request: {
                            page: 'curr' //页码的参数名称，默认：page
                            , limit: 'nums' //每页数据量的参数名，默认：limit
                        }
                        , where: {
                            search: demoReload.val()
                        }
                    });
                },
                calculat: function (data) {            //计算金额，重载页面
                    var count_num = 0;
                    var total = table.cache.testReload;
                    $.each(total, function (index, item) {
                        if (item.product_id === data.product_id) {
                            item.amount = data.unit_price * data.count;
                        }
                        ;
                        count_num += parseInt(item.amount);
                    })
                    var data1 = $("#sales_order_add input.changeable");
                    $.each(data1, function (index, item) {
                        count_num = count_num + parseInt($(item).val());
                    });

                    $("#id_total_amount").val(count_num);
                    self.subdact();
                    active["reload"].call(this, total);
                },
                submit: function () {                  //提交按钮
                    //first table
                    var inputAll = $("#sales_order_add").find("input");
                    var selectAll = $("#sales_order_add").find("select");
                    var obj1 = self.callback(inputAll);
                    var obj2 = self.callback(selectAll);
                    var data = $.extend({}, obj1, obj2);

                    var tableData = table.cache.testReload;
                    //third table
                    var tableAll = $("#collection").find("input[type!='checkbox']");
                    var tabSelect = $("#collection").find("select");
                    var len = $("#collection tr").length;
                    var array = [];
                    if (len) {
                        for (var i = 0; i < len; i++) {
                            array.push({
                                'receipt_type': $('[name="id_form-' + i + '-receipt_type"]').val(),
                                'receipt_time': $('[name="id_form-' + i + '-receipt_time"]').val(),
                                'receipt': $('[name="id_form-' + i + '-receipt"]').val(),
                                'remark': $('[name="id_form-' + i + '-remark"]').val()
                            })
                        }
                        data.sales_collection = JSON.stringify(array);
                    }
                    //data.csrfmiddlewaretoken = '{{ csrf_token }}';
                    data.sales_product = JSON.stringify(tableData);
                    console.log(JSON.stringify(data));
                    $.post("/sales/modify/", data, function (a, b) {
                        alert(a);
                    });
                }
            };
            $(document).on('change', 'input.changeable', function () {            //产品列表中的金额计算
                var count_num = 0;
                var total = table.cache.testReload;
                $.each(total, function (index, item) {
                    count_num += parseInt(item.amount);
                })
                var data1 = $("#sales_order_add input.changeable");
                $.each(data1, function (index, item) {
                    count_num = count_num + parseInt($(item).val());
                });

                $("#id_total_amount").val(count_num);
                self.subdact();
                active.calculat(total);
            });
            $('#infoDemo .layui-btn').on('click', function () {               //子页面的搜索按钮
                var othis = $(this), method = othis.data('method');
                active[method] ? active[method].call(this) : '';
            });
            $('.box-header .layui-btn').on('click', function () {             //提交监听
                var othis = $(this), method = othis.data('method');
                active[method] ? active[method].call(this) : '';
            });
        });

        $("#id_currency").change(function () {
            self.get_exrate()
        });
        $('#id_bill_amount').on('change',function(){
            self.subdact();
        });
        //get_exrate();

    }

};


    var data = {
        Initialize:function(){ 
            this.bind();
        },
        bind:function(){
            layui.use('laydate',function(){
                var laydate = layui.laydate,
                $ = layui.$;
                laydate.render({
                    elem:'#id_date'
                    ,lang:'en'
                });
            })
            
            //全局变量，标记name递增
            var collection_index = 0;
            //收款计划添加
            $('#collection_add').click(function () {
                var content = '<tr><td><input type="checkbox" style="width: 18px;height: 18px;"/></td><td><select id=\'change2\' name="id_form-'+ collection_index +'-receipt_type">' +
                    '<option value="">选择回款类型</option>' +
                    '<option value="预收款">预收款</option>' +
                    '<option  value="回款">回款</option>' +
                    '<option value="尾款">尾款</option>' +
                    '<option value="一次性回款">一次性回款</option>' +
                    '</select></td>';
                content += '<td><input class="time'+ collection_index +'" name="id_form-' + collection_index + '-receipt_time"/></td>';
                content += '<td><input class="changeable" name="id_form-'+ collection_index +'-receipt" placeholder="0.00"></td>';
                content += '<td><input class="changeable" name="id_form-'+ collection_index +'-remark" placeholder="无"></td></tr>';

                $('#collection').append(content);
                //执行一个laydate实例
                layui.use('laydate',function(){
                    var laydate = layui.laydate,
                    $ = layui.$;
                    laydate.render({
                        elem:'.time' + collection_index
                        ,lang:'en'
                    })
                });
                collection_index ++;
            });
            //收款计划全选设置
            $('#select_all2').change(function () {
                var checkstatue = $(this).prop('checked');
                $('#collection input[type="checkbox"]').prop('checked', checkstatue);
            });
            $(document).on('change','#collection input[type="checkbox"]',function(){
                var findAll = $("#collection").find("input[type='checkbox']");
                var data = [];
                    $.each(findAll,function(index,item){
                        var state = $(item).prop('checked');
                        data.push(state);
                    });
                if($.inArray(false,data)<0){
                    $("#select_all2").prop("checked",true);
                }else{
                    $("#select_all2").prop("checked",false);
                }
            });

            //删除收款计划选中的选项
            $('#Remove_collection').on("click",function(){
                $("#collection input[type='checkbox']:checked").parent().parent().remove();
                $("#collection").prev().find("input").prop("checked",false);
            });
            $(".chosen-select").chosen({
                no_results_text: "没有找到结果！",//搜索无结果时显示的提示
                search_contains:true,   //关键字模糊搜索，设置为false，则只从开头开始匹配
            });
            
        }
    };
    $(function(){
        obj.init([]);
        data.Initialize();
    })
</script>
{% endblock %}